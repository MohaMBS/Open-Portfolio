---
import { config } from "@/utils/config";

const { locales, defaultLocale } = config.i18n;
const currentLang = Astro.params.lang || defaultLocale;

// Logic to keep current route but change language
function getPathForLang(lang: string) {
  const currentPath = Astro.url.pathname;
  const segments = currentPath.split("/").filter(Boolean);

  if (segments.length > 0 && locales.includes(segments[0])) {
    segments[0] = lang;
  } else {
    segments.unshift(lang);
  }

  return `/${segments.join("/")}`;
}

// SVG Icons (Settings and Globe)
const Icons = {
  Settings: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>`,
  Globe: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="2" x2="22" y1="12" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>`,
  Check: `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>`,
};
---

<div class="fixed bottom-6 right-6 z-[100] group print:hidden font-sans">
  <div
    id="options-menu"
    class="absolute bottom-14 right-0 min-w-[160px] bg-white dark:bg-zinc-900 rounded-xl shadow-xl border border-gray-200 dark:border-zinc-800 transform scale-90 opacity-0 pointer-events-none transition-all duration-200 origin-bottom-right"
  >
    <div class="p-2 space-y-1">
      <div
        class="px-3 py-2 text-xs font-bold text-gray-400 uppercase tracking-wider border-b border-gray-100 dark:border-zinc-800 mb-1"
      >
        Language
      </div>

      {
        locales.map((lang) => {
          const isActive = lang === currentLang;
          return (
            <a
              href={getPathForLang(lang)}
              data-lang={lang}
              class:list={[
                "flex items-center justify-between w-full px-3 py-2 text-sm rounded-lg transition-colors lang-btn",
                isActive
                  ? "bg-gray-100 dark:bg-zinc-800 text-black dark:text-white font-medium"
                  : "text-gray-600 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-zinc-800 hover:text-black dark:hover:text-white",
              ]}
            >
              <div class="flex items-center gap-2">
                <Fragment set:html={Icons.Globe} />
                <span class="uppercase">{lang}</span>
              </div>
              {isActive && <Fragment set:html={Icons.Check} />}
            </a>
          );
        })
      }
    </div>
  </div>

  <button
    id="options-btn"
    aria-label="Options"
    class="flex items-center justify-center w-12 h-12 bg-black dark:bg-white text-white dark:text-black rounded-full shadow-lg hover:scale-110 active:scale-95 transition-all duration-300 hover:rotate-90"
  >
    <Fragment set:html={Icons.Settings} />
  </button>
</div>

<script>
  // Logic to open/close menu
  const btn = document.getElementById("options-btn");
  const menu = document.getElementById("options-menu");
  const langBtns = document.querySelectorAll(".lang-btn");
  let isOpen = false;

  function toggleMenu() {
    isOpen = !isOpen;
    if (isOpen) {
      menu?.classList.remove("scale-90", "opacity-0", "pointer-events-none");
      menu?.classList.add("scale-100", "opacity-100", "pointer-events-auto");
    } else {
      menu?.classList.add("scale-90", "opacity-0", "pointer-events-none");
      menu?.classList.remove("scale-100", "opacity-100", "pointer-events-auto");
    }
  }

  // Button Click Event
  btn?.addEventListener("click", (e) => {
    e.stopPropagation();
    toggleMenu();
  });

  // Close when clicking outside
  document.addEventListener("click", (e) => {
    if (
      isOpen &&
      menu &&
      !menu.contains(e.target as Node) &&
      !btn?.contains(e.target as Node)
    ) {
      toggleMenu();
    }
  });

  // Save language preference
  langBtns.forEach((btn) => {
    btn.addEventListener("click", () => {
      const lang = btn.getAttribute("data-lang");
      if (lang) localStorage.setItem("preferred_lang", lang);
    });
  });
</script>
